{"version":3,"sources":["tangojs-connector-local.js"],"names":[],"mappings":"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","file":"tangojs-connector-local.js","sourcesContent":["\n// FIXME '* as' should not be there\n// https://github.com/babel/babel/issues/95\n\nimport * as tangojs from 'tangojs'\n\n/** @private */\nfunction now() {\n  return (new Date()).getTime()\n}\n\n/** @private */\nfunction reject(message) {\n  return Promise.reject(new Error(message))\n}\n\n/**\n * In-memory connector implementation.\n */\nexport class LocalConnector extends tangojs.Connector {\n\n  /**\n   * @param {Object} data model\n   */\n  constructor(model) {\n    super()\n    /** @private */\n    this._model = model\n  }\n\n  /** @private */\n  _devicePromise(name) {\n    try {\n      let [domain, family, member] = name.split('/')\n      return Promise.resolve(this._model[domain][family][member])\n    } catch (error) {\n      return reject(`Invalid device name: '${name}'`)\n    }\n  }\n\n  /** @private */\n  _attributePromise(deviceName, attributeName) {\n    return this._devicePromise(deviceName).then(device =>\n      device.attributes && device.attributes[attributeName]\n        ? device.attributes[attributeName]\n        : reject(`Attribute not found: '${deviceName}/${attributeName}'`)\n    )\n  }\n\n  /** @private */\n  _commandPromise(deviceName, commandName) {\n    return this._devicePromise(deviceName).then(device =>\n      device.commands && device.commands[commandName]\n        ? device.commands[commandName]\n        : reject(`Command not found: '${deviceName}/${commandName}'`)\n    )\n  }\n\n  // --- tangojs.Connector implementation starts here ---\n\n  dbReadDomains() {\n    return this._model\n      ? Promise.resolve(Object.keys(this._model))\n      : Promise.reject(new Error('Invalid model'))\n  }\n\n  dbReadFamilies(domain) {\n    return this._model && this._model[domain]\n      ? Promise.resolve(Object.keys(this._model[domain]))\n      : Promise.reject(new Error(`Invalid domain: '${domain}'`))\n  }\n\n  dbReadMembers(domain, family) {\n    return this._model && this._model[domain] && this._model[domain][family]\n      ? Promise.resolve(Object.keys(this._model[domain][family]))\n      : Promise.reject(\n          new Error(`Invalid domain: '${domain}' or family: '${family}'`))\n  }\n\n  readDeviceStatus(deviceName) {\n    return this._devicePromise(deviceName).then(device => {\n      let [state, status] = device.status()\n      return new tangojs.DeviceStatusResponse(now(), state, status)\n    })\n  }\n\n  readDeviceInfo(deviceName) {\n    return this._devicePromise(deviceName).then(device =>\n      new tangojs.DeviceInfo(device.info())\n    )\n  }\n\n  readAttributesList(deviceName) {\n    return this._devicePromise(deviceName).then(device =>\n      Object.keys(device.attributes)\n    )\n  }\n\n  readAttributeValue(deviceName, attributeName) {\n    return this._attributePromise(deviceName, attributeName).then(attribute =>\n      new tangojs.AttributeReadResponse(now(), attribute.read(),\n        tangojs.AttributeQuality.ATTR_VALID)\n    )\n  }\n\n  writeAttributeValuesBulk(deviceName, nameValuePairs, sync = false,\n    reset = false) {\n\n    // attribute objects paired with values to write\n    let attributeValuePairsPromises = nameValuePairs.map(([name, value]) =>\n      this._attributePromise(deviceName, name).then(attr => [attr, value])\n    )\n\n    let quality = tangojs.AttributeQuality.ATTR_VALID\n\n    // write values and read stored results (if required)\n    let writeAttributeValuePairs = attributeValuePairs => attributeValuePairs\n      .map(([attr, value]) => [attr, attr.write(value)])\n      .map(([attr]) => sync\n        ? new tangojs.AttributeReadResponse(now(), attr.read(), quality)\n        : undefined\n      )\n\n    let changedNames = nameValuePairs.map(([n]) => n)\n\n    // reset parameters if required\n    let resetUnspecifiedIfRequired = (! reset)\n      ? (x => x)\n      : readResponses => this.readAttributesList(deviceName).then(allNames => {\n          let nonChangedAttributePromises = allNames\n            .filter(name => !(name in changedNames))\n            .map(name => this._attributePromise(deviceName, name))\n          return Promise.all(nonChangedAttributePromises)\n            .then(attrs => attrs.forEach(a => a.reset()))\n            .then(() => readResponses)\n        })\n\n    return Promise.all(attributeValuePairsPromises)\n      .then(writeAttributeValuePairs)\n      .then(resetUnspecifiedIfRequired)\n  }\n\n  readAttributeInfo(deviceName, attributeName) {\n    return this._attributePromise(deviceName, attributeName).then(attribute =>\n      new tangojs.AttributeInfo(attribute.info())\n    )\n  }\n\n  readCommandsList(deviceName) {\n    return this._devicePromise(deviceName).then(device =>\n      Object.keys(device.commands)\n    )\n  }\n\n  readCommandInfo(deviceName, commandName) {\n    return this._commandPromise(deviceName, commandName).then(command =>\n      new tangojs.CommandInfo(command.info())\n    )\n  }\n\n  executeCommand(deviceName, commandName, arg, sync) {\n    return this._commandPromise(deviceName, commandName).then(command => {\n      let result = command.execute(arg)\n      return sync\n        ? new tangojs.CommandOutputResponse(now(), result)\n        : undefined\n    })\n  }\n}\n"],"sourceRoot":"/source/"}